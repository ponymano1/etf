## 总体架构设计

### 设计原则

ETF 的架构设计遵循以下核心原则：

1. **安全第一**：采用经过验证的设计模式，最小化安全风险
2. **简单可靠**：避免过度设计，选择简单可靠的实现方案
3. **用户友好**：通过 USDT 作为统一入口，简化用户交互
4. **模块化**：清晰的职责分离，便于维护和升级
5. **透明可验证**：所有操作链上执行，支持实时审计

### 系统架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户钱包       │    │  ETFRouterV1    │    │ BlockETFCore    │
│                 │    │  (路由合约)      │    │  (核心合约)      │
│  - USDT         │◄──►│                 │◄──►│                 │
│  - ETF Shares   │    │  - USDT兑换     │    │  - 份额管理     │
└─────────────────┘    │  - 用户入口      │    │  - 资产管理     │
                       └─────────────────┘    │  - 权重调整     │
                                              └─────────────────┘
                                                       ▲
                                                       │
                       ┌─────────────────┐    ┌─────────────────┐
                       │  PriceOracle    │    │ ETFRebalancerV1 │
                       │  (价格预言机)     │    │  (再平衡合约)    │
                       │                 │    │                 │
                       │  - Chainlink    │    │  - 闪贷再平衡     │
                       │  - 价格聚合      │    │  - 自动执行       │
                       └─────────────────┘    └─────────────────┘
                                                       │
                                                       ▼
                       ┌─────────────────────────────────────────┐
                       │           DeFi协议层                     │
                       │                                         │
                       │  PancakeSwap V2/V3, Chainlink, etc.     │
                       └─────────────────────────────────────────┘
```

### 核心工作流程

**用户投资流程**：

1. 用户向 ETFRouterV1 发送 USDT
2. Router 计算所需的各种底层资产数量
3. Router 通过 DEX 将 USDT 兑换为底层资产
4. Router 调用 BlockETFCore 铸造 ETF 份额
5. 用户收到对应的 ETF 代币

**用户赎回流程**：

1. 用户向 ETFRouterV1 发送 ETF 代币
2. Router 调用 BlockETFCore 销毁 ETF 份额
3. Router 接收对应比例的底层资产
4. Router 通过 DEX 将底层资产换回 USDT
5. 用户收到 USDT

**重平衡流程**：

1. ETFRebalancerV1 监控资产权重偏离情况
2. 当偏离超过阈值时，触发重平衡流程
3. 通过闪贷机制临时获取资金
4. 卖出超配资产，购买欠配资产
5. 归还闪贷，完成重平衡

## 核心合约设计

### 1. BlockETFCore - 核心合约

**职责定义**：

- ETF 份额的发行与管理
- 底层资产的持有与分配
- 权重配置与调整
- 管理费用收取

**核心功能**：

```solidity
contract BlockETFCore is ERC20, Ownable, Pausable, ReentrancyGuard {
    // 资产信息结构
    struct AssetInfo {
        uint32 weight;        // 权重 (basis points)
        uint256 balance;      // 当前余额
        bool isActive;        // 是否活跃
    }

    // 核心功能函数
    function mint(uint256[] amounts, address to) external returns (uint256 shares);
    function burn(uint256 shares, address to) external returns (uint256[] amounts);
    function adjustWeights(uint32[] newWeights) external onlyOwner;
    function executeRebalance() external onlyOwner;
}
```

**设计亮点**：

- **ERC20 兼容**：ETF 份额作为标准代币，可在任何支持 ERC20 的平台交易
- **精确权重管理**：使用 basis points（万分之一）确保权重配置的精确性
- **闪贷接口**：支持`flashRebalance`，实现零成本重平衡
- **安全防护**：集成重入保护、暂停机制、权限控制等安全特性

### 2. ETFRouterV1 - 路由合约

**职责定义**：

- 简化用户交互体验
- USDT 与 ETF 份额的双向兑换
- 自动化的资产交换逻辑
- 滑点保护与价格估算

**核心功能**：

```solidity
contract ETFRouterV1 is Ownable, Pausable, ReentrancyGuard {
    // 用户友好的交互接口
    function mintWithUSDT(uint256 usdtAmount, uint256 minShares, uint256 deadline)
        external returns (uint256 shares);

    function burnToUSDT(uint256 shares, uint256 minUSDT, uint256 deadline)
        external returns (uint256 usdtAmount);

    // 价格估算功能
    function estimateSharesFromUSDT(uint256 usdtAmount) external view returns (uint256);
    function estimateUSDTFromBurn(uint256 shares) external view returns (uint256);
}
```

**设计亮点**：

- **USDT 作为统一入口**：用户无需了解底层资产构成，降低使用门槛
- **智能路由**：自动选择最优的交易路径（V2/V3）
- **滑点保护**：内置滑点检查，保护用户免受 MEV 攻击
- **价格预估**：提供准确的价格估算，帮助用户做出决策

### 3. ETFRebalancerV1 - 重平衡合约

**职责定义**：

- 监控资产权重偏离
- 自动执行重平衡操作
- 闪贷资金优化
- 交易成本最小化

**核心功能**：

```solidity
contract ETFRebalancerV1 is IRebalanceCallback, Ownable, Pausable {
    // 重平衡检查与执行
    function canRebalance() external view returns (bool needed, string memory reason);
    function executeRebalance() external;

    // 闪贷回调实现
    function rebalanceCallback(
        address[] calldata assets,
        int256[] calldata amounts,
        bytes calldata data
    ) external override;
}
```

**设计亮点**：

- **闪贷机制**：通过 ETFCore 的闪贷功能实现零成本重平衡
- **智能路径选择**：根据资产特性选择 V2 或 V3 进行交易
- **分阶段执行**：卖出 → 购买 → 归还的清晰流程
- **冷却机制**：防止频繁重平衡，降低交易成本

### 4. PriceOracle - 价格预言机

**职责定义**：

- 提供准确的资产价格数据
- 集成 Chainlink 价格 feed
- 价格时效性验证
- 精度标准化处理

**核心功能**：

```solidity
contract PriceOracle is Ownable {
    // 价格获取接口
    function getPrice(address token) external view returns (uint256 price);

    // 价格feed管理
    function setPriceFeed(address token, address feed) external onlyOwner;

    // 内部价格处理
    function getChainlinkPrice(address feed)
        external view returns (uint256 price, uint256 updatedAt);
}
```

**设计亮点**：

- **Chainlink 集成**：利用行业标准的去中心化价格 feed
- **时效性检查**：1 小时 staleness threshold 确保价格新鲜度
- **精度统一**：所有价格统一转换为 18 位小数精度
- **错误处理**：完善的异常处理和 fallback 机制
